name: Rust

on:
  push:
    branches: [ master ]

env:
  CARGO_TERM_COLOR: always
  IFS: $'\n'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
  
    - name: Get changed files
      run: echo "CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})"
    
    - name: send .md curls
      run: |
       for i in $(grep "pages" <(echo $CHANGED_FILES)); do
          a=$(basename $i '.md')
          curl https://gymskilltree.com/update_page?n=$a
       done
   
    - name: send .svg curls
      run: |
       for i in $(grep "packages" <(echo $CHANGED_FILES)); do
          a=$(basename $i '.svg')
          b=$(basename $(dirname $i))
          curl https://gymskilltree.com/update_package?p=$a&n=$b
       done
   
    - name: run rust script
      run: |
       FILE=./skilltree-docs
       if [ -f "$FILE" ]; then
         exec $FILE
       else 
         cargo build --release
         cp ./target/release/skilltree-docs ./
         git config --local user.name "MoreTacos"
         git add $FILE
         git commit -m "Adding executable file"
         exec $FILE
         rm -rf ./target
       fi
   
    - name: Push changes # push the output folder to your repo
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        force: true
